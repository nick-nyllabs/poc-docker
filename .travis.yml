language: node_js
node_js:
- node
- '7'
sudo: required
services: docker
env:
  global:
  - secure: SxEoBhiI2o3r2ERrYCqZB1zJXEnhk4pYV1xiO6H72gVjwCfb21K/HNwu8I5PcXoUJ9E+p0f9yGOxzNIGoJ0khagk6RNF7jE9nRSdgYY6u9lh5oM3AnbLHnmE9oJlmU61bQyFvWDOLH2GjsijUQYovki88UL6Xq1KDvFpuWorCkddMH/7TDR5/EJjKh0dyf/qMw2vvyE6XUVX7XzuiuXJXpGdmolMINypQXvXccNfzqaiqqnWvRvW3o5x4fq5mMgTnNh25BjPf8HhzqpehB8bL6R2pBRshjaQLMKSRbTYcHEA0n4uVgYqiE6IMJutyX7phgijykS2Zo672hpAdOLNnwyvsKFs8awLtuMFPebYI0fj7n5yy8Kg82fiwqprOLWh5elzasiYamaf8wJQcKZsTGTuvbU/yJPWXzcVI/PqqGlNZHsed8RPoJE1PknDivzHGNiFrB0WCoOOQYKD0q5GUalqMwL5EXnqGyfQcT7DjTPLGrqUY7Vs45qT0CBFmY/mo8n/7c4gWrvfcAwm6VPrzZQiiOkp2plHba9S3ADNnaZPxr1Kjdfw1tgPiI2JeM70yjSgot/hV0uuA20ot7xF4NjedpAz5e/KG1Dpg8z7yrT42G/oZ2fi85YhnMyfQ9qagG5nxT02xmcg9H1oT3l1VqRUGaU2ZbafRzFe3aLlpW4=
  - secure: MBzj62no+4EQSQaspS9yTdTInB7F4e47lXn1N8OfdyxNI3822yb6ModMJowcdFlseouUhs2WDS3MgbanVwIAN5cNvDmPOYvybjts6eJqHt1enZKY5utqNddCLZCF0nyH2zVYlGl93/i4xRLyiUlIm7wIVRpTRDC+wTyv8/gujpeICXXEBpwEULHKcqQFYYpa2QjAdb3RkkxJ6OSUueFJNZEwu3zBBaQDqreKulq6TgsGytWmkdqHdGfpDxe1QtxdRik3jOe/WOLTr2oUVIraUaLnCLG2r5eJ9aBGuLzB+kShy3lVkCq7dhRngU4IZli3U8KGW6FYbFXwhajOeV7wytx4o7nMkAWaZEOJvjZR7D80tk2d7TmVr0jSFHzdbWkTEYmvhy7t8blXqxv+q+Ar6iOpaoNNZWROzGEb51p4XrCgMNwbvSlWxKI9kAh6WFs/C8KFpfYKYbA39cJD3GwQ5sZEi3dmnlkCWU0pFAB2sZ5AdZyiaFBZ19jKxVxpbhzFPXex+xReBv+UET2TtH/HRSnqGyy67R1sB2ljSIa4CK/9InMCpe6OuBOB46Y5sUBhQ1jkgYcDF+n4b5ypV9VoOnnLIe1ex6/NBGx0Q/mwWfC8/LsDMc5maPhUr7ZM4+wtxYGf1pL+j/QCgl08dBvwYOtPZAeMGSOKDyhOD9em+Z0=
  - secure: B8W2BYvaL+RiQK8yzOZL/2e2jsQMEjEa1O1zFH+kyJIqiru5P3Fxi7TpvecRHFwR9Fg93enTtU0YMW19UPxx/VAbJ1zQflZtQn55Up6oRXmDmq+ySSKZgmtDRn1rmKW8ShCYwXzrQo1ygqXOARrI+5mhDoi06l4f4NVrq+3hxccyb2e0xbz8MRMaTVOjVRbotQIYIMHi9AtIjohd3d4Idd3waLqOI3l0YBKaYC0R6VT0Q7cyiHrx352M3XGcuVRPk7aBSivoMmul7sv5IVUNL46Kqk/75maDXFiaKiI1AyeDPxAg/TE4aTa/y6IIzON03sNTQk0LXJTsoVV44u316CV7w0ACBUKtngzPzR4wxx46YhmEpthXl5RmR3jDSU1dFykuFY2L9FOaUo33zRaOBhomstpKjkl5pb/hGleZCNpiumXhn64F+5H/C3MsLYWCavvNcuekoFBE5mdwUGBMnbACp6y/IDob63LoePC8eYSbNmHT585zIdDoOICnphxaG2cphXlicgOkbBf3T4uaJgoH5eTRFww007jzptCOdT4sOsS566disZES0Vvmpg8j1X86TVvNQgmVgpQOArb72t5JXEX9Q5UDlyHbnVNC5fPAxQ2jK45JJljaIcn6vbx+cgtFxK4+g/QtPoO+ApWBnhPX8ikPaF2Vvbf39zRfiVE=
  - COMMIT=${TRAVIS_COMMIT::6}
  - secure: jNubHlS5kDE3AhJ44jhgAP02t5qb+AZAmfW4JjZJq0QkrFS+yRWcXlfaLqi27Gd/rukBqDHER0qGPx4uc9av49+KO1ypG0QVdR92dtnNoWk2QXBBTF1xnEDkhKNO24x9JQXYHqIh+SYu/wzAfZjZxO99wKghnfjwYX/QSkobwMD5IaeE7EZT1Z9lRrFaa9NIrLlJxRE6GwpK8h1B9Pq0qcemilk+7JJjJVpJlzFvAbBzZa2Oflxm9hn7AXsatD/LjSxSDDodqvvMiqyq+DhewowbNUDYwRRiVamI55d0tSN5/iC65Xzk02R798TL+ukgiBhH4blektt1qcwNA+wg246ES1TjvOMRXR4QJ3hnl48mrv0wDSDtEdqPiOmP9gM+3WKsedjUuHFQ6z8pX8FN+GrnxeiytbYriJy9hn/j5xcbEf4KPSmtd00qaYAg4hzSY1jVi0G2FTU9yOD95yGoJrs2N68RIyRaGwgnCO67gx7vyQ7yNSYQwfp2PBC90ekhJ3KeLpDjlO8+Ab9pNIWGamZHKxnysmCE3EGSzAoVXrdIc2ldibpfpzU6ZEPyvp6lB+6SA58yE4G3W1ntrNwyyjAWC3h0IEA4ZqIlcmJJ7WI8mvtixHZvPyu3qRvL2Snb+zZUYWIs6RIzHX7xB+kzUtYG86K8b4OkTbjxDg+BkDI=
  - secure: g0P790M2e43dYBUAamsGSb4jqD2FNl87y5VC3A9I+NnyOTFJWaiuqBfj9yrpjV7Ro1Ve5V8zzwb1iHdv+qU7UBJl0JzsieoX4SlhSBcVC7MD9AvQJAmketdBv9+m/sDI9h7dnmk17SjZymP2kmM51zYFQ8N/QFHhjV+aROLZCfqvtMtdl3QOS8WXlSsuUngawo13ib1v5oyucmDiPKUFryuiMfBgu3DaXxwmPog89gcZAxMUudtigU8nb1663NYEtA0+F13roffGPuyaKl/fpzoPmqI3xCaDfGpEqqXCECFtzxxcKc9gY9ow9VR+Kf8NHNjTws6lkQCO6v4U2a5F483U9THZNKTLyDEySPv8yWi4guO4Cl6BwmvGO20SJtF8d+Tt6b5t6Bkr27HFR+ZkqJNy+jY6Sh3NjiQ6xsv1YG8Pa6mOyp1qO0EHxqybBDIOHgTCXtx0p1H0ZePQamvJvdvHLdvH/t6YLmshIIsGU1bM70g9aQKIiuY47ADzxdC5AWxOUjI5nWHXKAQYWcx83LL9lPrtIiGC/jIUv2uECa9NCdYCCxzEKDziZBh8z+7Vs5xdjcIf5vXkTBjPgYkJqtQH8QXrySSxo7Fb/9P7kgSVP0kNu2w+a1vHWwvNQfbJp28rG+F4zoCZwklae+tJkXjs/ixzctVMgLBR5xYO7JY=
before_install:
- docker build -t testimage .
- docker run -d -p 80:3000 testimage
- npm i -g mocha
script: npm test
after_success:
- docker --version
- pip install --user awscli
- export PATH=$PATH:$HOME/.local/bin
- eval $(aws ecr get-login --region us-west2)
- docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
- export REPO=$DOCKER_USER/k-auth
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH
  ; fi`
- echo $REPO:$TAG:$COMMIT
- docker build -f Dockerfile -t $REPO:$COMMIT .
- docker tag $REPO:$COMMIT $REPO:$TAG
- docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
- docker push 288824224421.dkr.ecr.us-west-2.amazonaws.com/worksite-microservices
